---- crm_cust_info

INSERT INTO silver.crm_cust_info (
			cst_id, 
			cst_key, 
			cst_firstname, 
			cst_lastname, 
			cst_marital_status, 
			cst_gndr,
			cst_create_date
		)
 select 
cst_id,
cst_key,
TRIM(cst_firstname) as cst_firstname,
TRIM(cst_lastname) as cst_lastname,
CASE
 WHEN Upper(TRIM(cst_marital_status)) = 'S' then 'Single'
 WHEN Upper(TRIM(cst_marital_status)) = 'M' then 'Married'
 else 'n/a'
 end as cst_marital_status,
 CASE
 WHEN Upper(TRIM(cst_gndr)) = 'M' then 'Male'
 WHEN Upper(TRIM(cst_gndr)) = 'F' then 'Female'
 else 'n/a'
 end as cst_gndr,
 cst_create_date
from
(
SELECT *,
ROW_NUMBER() OVER(PARTITION by cst_id ORDER BY cst_create_date DESC) as rank_by_create_date
from bronze.crm_cust_info
) as t
where rank_by_create_date = 1 and cst_id is not null;


--- crm_prd_info 

INSERT INTO silver.crm_prd_info (
			prd_id,
			cat_id,
			prd_key,
			prd_nm,
			prd_cost,
			prd_line,
			prd_start_date,
			prd_end_Date
		)
select prd_id,
REPLACE(SUBSTRING(prd_Key,1,5),'-','_') as cat_id,
SUBSTRING(prd_key,7,LEN(prd_Key)) as prd_Key,
prd_nm,
ISNULL(prd_cost,0) as prd_cost,
CASE
WHEN UPPER(TRIM(prd_line)) = 'M' THEN 'Mountain'
				WHEN UPPER(TRIM(prd_line)) = 'R' THEN 'Road'
				WHEN UPPER(TRIM(prd_line)) = 'S' THEN 'Other Sales'
				WHEN UPPER(TRIM(prd_line)) = 'T' THEN 'Touring'
				ELSE 'n/a'
			END AS prd_line,
            cast(prd_start_dt as Date) as Prd_start_date,
            cast(lead(prd_end_dt) over(partition by prd_Key Order by prd_Start_dt)-1 As date) as prd_end_Date
from
bronze.crm_prd_info


----silver.crm_sales_details

 IF OBJECT_ID('silver.crm_sales_details', 'U') IS NOT NULL
    DROP TABLE silver.crm_sales_details;


	CREATE TABLE silver.crm_sales_details (
    sls_ord_num NVARCHAR(50),
    sls_prd_key NVARCHAR(50),
    sls_cust_id INT,
    sls_order_dt DATE,
    sls_ship_dt DATE,
    sls_due_dt DATE,
    sls_sales INT,
    sls_quantity INT,
    sls_price INT,
    dwh_create_date DATETIME2 DEFAULT GETDATE()
);


 INSERT INTO silver.crm_sales_details (
			sls_ord_num,
			sls_prd_key,
			sls_cust_id,
			sls_order_dt,
			sls_ship_dt,
			sls_due_dt,
			sls_sales,
			sls_quantity,
			sls_price
		)
  select sls_ord_num,sls_prd_key,
  sls_cust_id,
  Case
  when sls_order_dt =0 or len(sls_order_dt)!=8 then null
  else cast(cast(sls_order_dt as varchar) As Date)
  end sls_order_dt,
  case
  when sls_ship_dt =0 or len(sls_ship_dt)!=8 then null
  else cast(cast(sls_ship_dt as varchar) As Date)
  end sls_ship_dt,
  case
  when sls_due_dt =0 or len(sls_due_dt)!=8 then null
  else cast(cast(sls_due_dt as varchar) As Date)
  end sls_due_dt,
   case 
   when sls_sales is nUll or sls_sales <=0 or sls_sales != sls_price * Abs(sls_quantity)
   then sls_quantity * abs(sls_price)
   else sls_sales
   end As  sls_sales,
   sls_quantity,
   case
    when sls_price is nUll or sls_sales <=0 
   then sls_sales/ nullif(sls_quantity,0)
   else  sls_price
   end As  sls_price
  from Bronze.crm_sales_details


----- silver.erp_cust_az12 


INSERT INTO silver.erp_cust_az12 (
			cid,
			bdate,
			gen
		)
SELECT 
 CASE
  when cid LIKE 'NAS%' THEN SUBSTRING(cid,4,len(cid))
  else CID
  END CID,
  CASE 
  WHEN bdate > GETDATE()  or  bdate < '1925-10-17' then  NULL
  else bdate
  end as bdate,
  CASE
  when upper(trim(gen)) IN ('M','MALE') THEN 'MALE'
  when upper(trim(gen)) IN ('F','FEMALE') THEN 'FEMALE'
  ELSE 'n/a'
  end as gen
  FROM bronze.erp_cust_az12;
---silver.erp_loc_a101
INSERT INTO silver.erp_loc_a101 (
			cid,
			cntry
		)
SELECT 
REPLACE(cid,'-','') as cid,
CASE 
 WHEN TRIM(cntry) = 'DE' then 'Germany'
 WHEN TRIM(cntry) IN ('US','USA') then 'United States'
 when trim(cntry) = '' or cntry IS NULL  then 'n/a'
 else trim(cntry)
 end as cntry
FROM bronze.erp_loc_a101;


-----silver.erp_px_cat_g1v2 


INSERT INTO silver.erp_px_cat_g1v2 (
			id,
			cat,
			subcat,
			maintenance
		)
		SELECT
			id,
			cat,
			subcat,
			maintenance
		FROM bronze.erp_px_cat_g1v2;

